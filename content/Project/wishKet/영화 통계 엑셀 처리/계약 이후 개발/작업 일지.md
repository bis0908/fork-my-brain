---
Create at: 2024-05-26
---
---

### 메일함 모니터링 파트
- [[메일함 - 공통]]

### 크롤링 파트
- [[크롤링 파트 - 기본 정보]]
### DB 파트
##### 기본 사항
- 오라클에서 변수 대입은 `'=:'` 형식을 사용한다.
- 마치 `a = 10` 이러는 것과 같다.

### 통계 페이지 화면 표시
- ui
	- week 별 선택 기능 (캘린더)
	- 통계 엑셀 다운로드 기능
- 

---

##### 2024-06-04(화)
- db에 엑셀 데이터를 insert하는 부분과
- 화면에 표시하는 부분이 있음.
- 화면에 표시하는 부분에 누락이 있으면 안됨
- 화면에서 출력하는 정보를 어디서 가져오는지 분석 필요
- 기존 엑셀 업로드를 어떻게 하는가 보니, 업로드를 누르면 rootDir>upload>excel>ymd 형식의 폴더를 만들고 거기에 `$tmp_file_name`을 추가한다.
- 그리고 이 추가한 파일 이름을 엑셀 db 업로드 경로로 던진다.
- 나는 처음부터 저 경로로 파일을 받아놓고 파일명+파라미터 정보를 담아서 `/ScoreMng.excel_scoreA` 에게 던져주면 됨.
- `excel_scoreA`에서 어떻게 받느냐 인데...
- 우선 프린터 매칭해서 파라미터를 채우는 함수를 작성해야 한다.
- **단순하게 영화 명 만으로는 프린트 값 정확히 구분하는데 어려움이 있음**
- cgv 엑셀 등록 코드 확인
- lotte 엑셀 등록 코드
- 메가박스 등록 코드
- 씨네큐 등록 코드
- 영진위(비계열사) 등록 코드
- db insert를 하는 구간
	- `controllers/admin/score_mng/ScoreMng.class.php`
		- `excel_schedule_save()`
		- `excel_score_insert()`

---

##### 2024-06-05
> 지금 당장 해야 하는 것. 이제 더 이상 삽질을 할 시간이 없으니
> 엑셀 insert 관련된 DB 테이블 분석을 모두 진행하고 진행 유무를 판단할 것.
> db 결과를 조합해 보여주는 최종 화면 쿼리도 확인할 것.
- CGV 엑셀 추가 프로세스
	- `SW_SCORE_UPLOAD` 테이블에서 하루 전 데이터 제거
	- `SW_SCORE_UPLOAD` 에 함수 호출에서 넘어온 엑셀 정보 중 상영시작일, 계열사 정보를 제거한다.
	- 업로드 되어있는 엑셀을 읽기 위해 리더 객체 생성.
	- 열의 값들을 읽고 배열에 키:값 형태로 추가.
	- `excel_cnm_info2($data)`로 영화관 정보를 2차원 배열로 리턴.
		- 관련 테이블: `SW_CNM_INFO`, `SW_CNM_MD_INFO`
	- 그 다음 `excel_cnm_rm_info($data)` 로 상영관 시퀀스를 가져온다.
		- 테이블: `SW_CNM_RM_INFO`, `SCORE_CNM_ROOM`
	- 가져온 값을 `$excel_data`의 특정 키 값으로 할당
		- `excel_schedule_score_room_check($excel_data)`로 전송
		- 테이블: `SW_SCHEDULE_SCORE_INFO`, `SW_SCHEDULE_DATA`


---

##### 2024-06-06
- [x] 씨네큐 엑셀화 작업 ✅ 2024-06-06
- [x] 영진위 영화 테이블 링크 이동 문제 처리 ✅ 2024-06-06
- [x] cgv 메일함 가져오는 것 검증 ✅ 2024-06-06

1. 씨네큐 -> 엑셀 변환 및 파일 저장.
	-> 완료

2. 네이버 메일함 cgv: 메일을 가져올때 오늘 날짜에 수신된 메일만 받아야 하는데 어제자 메일 한개가 들어오는 이슈가 있어서 테스트 필요
	-> 내일 실 테스트 예정

3. 영진위에서 영화 통계 > 영화 상세 통계로 넘어가서 데이터 받기 전 
영화 통계 페이지에서 2건이 노출된다고 가정했을때, 두번째 영화의 세부 페이지로 넘어가지 못하는 증상 발견해서 확인 필요.
	-> 코드 검토 중

4. 영진위에서 받는 정보에서 프린트 값을 찾을 수 없어서 다른 페이지에서 크롤링하라고 고객사에서 알려준게 있어서 그부분 확인하고 크롤링 필요하면 작업 필요.
	-> 서브 개발자에게 요청

5. 모든 영화 정보를 가져오는 작업에서 프린트 정보를 제대로 파싱해야하는데...
   프린트 정보란 imax or screenx or 기타 상영관 특징 + 2d, 3d, 4d, 2d자막이나 더빙, 3d자막이나 더빙.. 이런 것들을 말함.

	영화명 만으로 국내영화인지 해외영화인지 알아낼 방법 무엇이 있을까?

	이걸 제대로 못했음. 정확히 말하면 수동으로 엑셀 업로드시 각 프린트 정보마다 대응값들이 있는데, 이 작업이 제일 클 것 같음.
	-> 서브 개발자에게 요청

6. test/main_process.php 에서 각 크롤링 사이트별 계정 정보를 DB로 쿼리해오려고 했지만 연결 실패함. 원인 파악 필요.
	-> 처리 완료. 
	-> 계정 정보 배열로 루프 돌면서 크롤링 프로세스 순환 작업 남음

7. 씨네큐 로그인이 현재 안되고 있음. (오전에 몇번 동작했는데 테이블 object를 찾지 못함. 테스트를 위해 실제 통계가 있는 날짜로 강제 지정하고 url을 날려봤지만 동일 증상)
	-> 처리 완료

8. 각 엑셀별 티켓금액 0원은 제외되어야 함
- [x] 영진위 - 확인
- [x] 씨네큐 - 확인
- [x] 메가박스 - 확인
- [x] 롯데 - 확인
- [x] CGV

9. 각 프로세스별로 성공 실패여부를 던져야 함.
	-> 작업 시작
- [x] 네이버 메일함 수집부 ✅ 2024-06-06
- [x] cgv ✅ 2024-06-06
- [x] 롯데 파싱 ✅ 2024-06-06
- [x] 메가박스 ✅ 2024-06-06
- [x] 씨네큐 ✅ 2024-06-07
- [x] 영진위 크롤링 ✅ 2024-06-07
- [x] 영진위 파싱 ✅ 2024-06-07

10. 계정 정보 배열로 루프 돌면서 크롤링 프로세스 순환 작업 남음

11. 크롤링 프로젝트 파일 재배치 및 db 계정 로딩으로 메인프로세스 자동화 
    -> 파일 배치 자동화 작업 (처리 완료된 엑셀 제거 등)
	-> 작업 예정


---

##### 2024-06-07
- 지금 너가 해야할 행동은 전반적으로 남은 모든 일 정리 겸 파악 
- 너가 할 수 있는 범위를 우선 확실하게 정리 
- 남은 범위는 동생에서 토스 
- 기영이가 지금 어느정도 해둔 부금계산 쪽은 어찌 진행해야할지 
  물어볼 내용은 물어볼 내용 따로 정리 
- 물어볼 내용 정리 중 부금계산에 해야할 행위들을 다 해봐서 물어볼내용은 확정적으로 다시 확인 
- 추후 너는 어디까지 동생은 어디까지 동생이 필요없다면 필요없다로 나에게 이야기해줘야함

- 지금 남은 업무들
- 부금 계산
- 상세 스코어 테이블 컬럼 추가 및 액션

```text
1. 일일스코어 > 스코어상세정보 페이지
- 공급가액이 맞지 않음.
- 스코어 상세정보에 공급가액값이 제대로 나오게 수정(부금기본 메뉴의 값이 정상 값)
- 스코어 상세정보에 추가할 컬럼
    부율, 부가세, 당사입금액, 기금(y/n), 시작일/종료일
  

2. 부금기본 페이지
- 부금 계산 수식 확인 필요
- 월 단위로 조회하면 데이터가 일치함
- 특정 기간 조회시 조회되는 데이터가 정확하도록 수정.


스코어상세정보 페이지 부금금액 통계 기능 요구사항 정리
1. 컬럼 추가
날짜(from), 날짜(to), 부율, 공급가액, 부가세, 당사입금액, 기금YN
컬럼 순서
지역 / 계열사 / 운영 / 극장명 / 프린트 / 날짜 (from) / 날짜 (to) / 관객수 / 매출액 / 기금제외금액 / 부율 / 공급가액 / 부가세 / 당사입금액 / 기금YN / 상영횟수 / 총좌석수 / 좌석점유율

2. 부율합산 기능 추가
부금기본 메뉴의 부율합산 checkbox처럼 스코어 상세정보에도 기능 추가

3.요금별 버튼 클릭했을 때
부율 / 공급가액 / 부가세 / 당사입금액 / 기금YN추가

4.스크린별 버튼 클릭했을 때
부율 / 공급가액/ 부가세 / 당사입금액 / 기금YN추가

5.일자별 버튼 클릭했을 때
부율 / 공급가액 / 부가세 / 당사입금액 / 기금YN추가
```

- 부금 기본 데이터가 맞지 않는다는걸 이해할 수 있는 근거자료 필요
- 고객사측에 문의했고 답변 받았음

- 부금 기본 테이블의 일부 열을 떼어와서 스코어 상세 페이지에 붙여야 함.
- 부금기본 테이블명: `SW_TOTAL_AMT_DATA`
	- 검색기간, 영화 코드, 지역, 계열사, 프린트 선택을 기반으로
	- 지역 / 계열사 / 운영 방식 / 극장명 / 프린트종류 / 상영from / 상영to / 인원 / 입장료 / 기금제외금액 / 부율 / 공급가액 / 부가세 / 당사 입금액 / 마감확인 열로 정렬해 출력한다.
- 기금의 의미: 영화발전기금. (https://www.kofic.or.kr/kofic/business/omng/introMngSelf_09.do)
- 기금YN: 발전기금 면제 or 부과 대상인지를 의미하며 테이블에 해당 정보가 이미 존재하는지 체크 필요

---

##### 2024-06-08
1. 네이버 
	1. cgv
		1. [x] 다운로드 확인 ✅ 2024-06-08
		2. [x] 파일명 영문 변경 ✅ 2024-06-08
	2. 롯데 엑셀 파일 다운 체크
		1. [x] 다운로드 확인 ✅ 2024-06-08
		2. [x] 파일명 영문 변경 ✅ 2024-06-08
3. 씨네큐 다운 체크
	1. [x] 다운로드 확인 ✅ 2024-06-08
	2. [x] 파일명 영문 변경 ✅ 2024-06-08
4. 영진위
	1. [ ] 다운로드 확인
		1. [ ] 문제발생
		2. [ ] 테스트 폴더에서 각각 5개 계정 정보를 넣고 루프 한번 돌렸을때는 다운로드가 잘 됐다.
		3. [ ] 배치 폴더에서는 하나도 제대로 받질 못했다.
		4. [ ] 원인은 무엇인가
		5. [ ] 테이블의 첫번째 행 링크에 접근 -> 다운로드 성공
		6. [ ] 두번째 행 링크에 접근 -> 다운로드 실패
		7. [ ] 오류: 이동해야 하는 링크의 텍스트가 잘못된게 들어가 있었음.
		8. [ ] 테스트 파일은 동작해서 그 파일 그대로 가져왔고 파일 저장 경로만 수정함
		9. [ ] 향후 이 문제가 다시 발생하면 그때 또 개삽질을 할 가능성이 있다.
		10. [x] 확인결과 엑셀 파일 생성 코드 제일 마지막 줄에서 curl close가 발생하고 있어서 프로토콜이 초기화 되어 기존 세션을 날리게 되는 문제가 발생해 벌어진 일이었다. ✅ 2024-06-09
	2. [x] 파일명 영문 변환 ✅ 2024-06-08
5. [ ] 메가박스
	1. [ ] 메가박스플러스엠 로그인 후 영화 조회시 데이터는 출력되지만 못받는 데이터 있음
	2. [x] 영진위와 동일한 증상으로 처리 하였음. ✅ 2024-06-09
6. 전체 사이트 크롤링 테스트
	1. 씨네큐 파일 저장시 테이블 복합 구조 파싱이 제대로 되지 않아 상영관 값이 영화관 열에서 보이는 이슈가 발생, 코드 파악하는중...

---

##### 2024-06-09
1. 업로드 배치파일 경로 (/home/www/cjy2/cli/batch.excel_load.php)
2. 부금 기본 & 스코어 상세 페이지 

---

##### 2024-06-13 (목)

- A 방향)
	사장의 논지: 파이썬 사이트를 볼 필요가 없다. php에만 집중해라.
	우리 쪽 의견: 자동으로 매치하는 코드가 없다. 이것을 증명하면 된다.

- B방향 )
	혹시 자동으로 매치하는 코드가 있을 경우,
	해줘야 한다.
	**명확하게 해야하는 내용을 서로 확인하고 진행 할 필요가 있음**
	(ex, 업무 리스트에 이제까지 진행사항(일정포함), 앞으로의 진행사항(일정포함))

- 영화 정보 테이블: SW_MOVIE_INFO
	- madin_gbn 열: 국내/해외 구분 (방화/외화)
- 영화별 프린트 구분 문구: SW_MOVIE_PRINT_ALIAS 


- #### 새로운 문제

---

##### 2024-06-14(금)
- **사과문 작성**
안녕하세요, 먼저 프로젝트 진행 중 발생한 문제로 인해 불편을 드려 대단히 죄송하다는 말씀을 드리고자 합니다.
초반 소스 분석 과정에서 미흡한 점이 있었고, 그로 인해 잘못된 정보를 전달하게 되었습니다.
이로 인해 상호간의 불필요한 분쟁이 발생하게 된 점 진심으로 사과드립니다.

저의 부족함을 인정하고, 이를 바로잡기 위해 소스 분석을 다시 철저히 진행하였습니다.
그 결과, 초기에 잘못된 분석으로 인해 업무 범위 산정이 불필요하게 확대되었음을 확인하였습니다.
이러한 실수가 발생한 점 다시 한번 사과드립니다.

앞으로의 계획과 일정을 아래와 같이 세분화하여 공유드리고자 합니다.

엑셀 데이터 수집 공통:
  - 티켓 0원은 제외한다.

cgv
  - 프린트 정보를 메일 제목 혹은 엑셀 파일 내부에서 추출하는 로직 작성
  - 기존 api 연동 db 적재 테스트
  - 작업일: 3일

롯데
  - 기존 api 연동 db 적재 테스트
  - 작업일: 1일

메가박스
  - 기존 api 연동(메가박스) db 적재 테스트
  - 작업일: 1일

씨네큐
  - 엑셀 raw 데이터 크롤링시 열 정보가 쏠리는 이슈 수정
  - 기존 api 연동(to 메가박스) db 적재 테스트
  - 작업일: 2일

영진위
  - 기존 api 연동(to 메가박스) db 적재 테스트
  - 작업일: 1일

+ 각 계열사별 db 업로드 수행시 성공/실패시 사유를 볼 수 있는 대시보드 추가
	+ 작업일: 1일

+ 스코어 상세 페이지 공급가액 수정 / 부금기본 페이지의 컬럼을 스코어 상세 페이지 추가
	+ 작업일: 7일

- 크롬 브라우저 업데이트로 인한 값 입력 문제
	- 클라이언트 측에서 자체 해결함.


A 작업 (상세 설명)

시작일: [시작일]
완료 예정일: [완료 예정일]
B 작업 (상세 설명)

시작일: [시작일]
완료 예정일: [완료 예정일]
C 작업 (상세 설명)

시작일: [시작일]
완료 예정일: [완료 예정일]

위 일정을 통해 프로젝트를 완수할 예정이며, 모든 작업은 철저히 계획에 맞춰 진행될 것입니다. 
작업 진행 상황을 주기적으로 보고드리며, 특이사항 발생시 즉가 공유드리도록 하겠습니다..

다시 한번, 이번 일로 불편을 드린 점 깊이 사과드리며, 
앞으로는 이러한 실수가 재발하지 않도록 최선을 다하겠습니다. 
추가적인 문의사항이나 논의가 필요하신 부분이 있으시면 언제든지 말씀해 주십시오.

감사합니다.


- 남은 업무 기간
- 할 수 있는가?
- 사과문을 보내는 일보다 내가 해낼 수 있느냐가 중요했다.

##### 2024-06-19
- 결국 프로젝트는 드랍 되었다.
- 드랍 이전 상황은 외부 공격으로 인해 db 데이터가 일부 소실된 상황이었다.
- 비밀번호 변경 외 복구 작업 지원을 했지만, 안타깝게도 복구에 관련된 설정에 실패했다.
- 