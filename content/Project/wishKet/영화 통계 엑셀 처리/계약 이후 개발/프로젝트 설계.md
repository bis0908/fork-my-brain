---
Create at: 2024-05-26
---
---

1. 프로젝트 목표
- 영화 통합 판매 데이터를 수집하여 DB에 저장하고, 이를 바탕으로 주간 통계를 생성하는 것

2. 데이터 수집 대상 
- 네이버 메일함: CGV, 롯데시네마 -> 엑셀 데이터
- 크롤링 필요한 사이트 (메가박스, 씨네큐, 영화진흥위원회)

3. DB
- 공통 필드(nullable): 상영일, 업체명, 영화명, 영화코드, 상영일자, 극장명, 극장코드, 상영관, 상영회차, x티켓 가격, 티켓 수 등
- 신규 테이블 생성 및 데이터 적재
- CREATE TABLE movie_schedule (
    id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    show_date DATE, // 상영일
    theater_code VARCHAR2(10), // 극장 코드
    theater_name VARCHAR2(100), // 극장명
    movie_code VARCHAR2(20), // 영화코드
    movie_name VARCHAR2(50), // 영화명
    screen_room VARCHAR2(100), // 상영관
    show_sequence NUMBER, // 상영회차
    show_time DATE, // 상영시간
    special_show CHAR(1) DEFAULT 'N' CHECK (special_show IN ('Y', 'N')), // 특회
    price NUMBER(10,2), // 티켓 가격
    ticket_count NUMBER // 티켓 수
);

4. 데이터 수집 및 파싱
   - 네이버 엑셀 파일 (메일함)
	   - CGV (첨부 엑셀 파일)
		   - 시트의 모든 행을 배열로 파싱.
		   - 각 행을 반복하면서 데이터를 파싱한다.
		   - 극장 코드, 극장명, 영화 코드, 영화명, 상영관이 모두 있는 경우, 영화 정보를 저장하고 영화 정보 테이블에 삽입한다.
		   - 가격 정보가 있는 경우, 해당 열의 인덱스를 찾아 상영 시간과 회차, 특별 상영 여부를 파악. 이 정보를 상영회차 정보 테이블에 삽입하고, 가격과 티켓 수량 정보를 티켓 판매 정보 테이블에 삽입한다.
	   - 롯데시네마 (메일 본문 링크 타고 url 이동)
		 - 메일 본문의 a 링크로 이동.
		 - querySelector('#UbiHTMLViewerUbiToolbarButton_SaveExcelBase').click();
		   을 실행해 엑셀 파일로 다운 받는다.
		 - 이때 "회차별부금.xlsx" 이라는 파일명으로 저장되는데 만약 기존 파일이 존재할 경우 제거한 다음 저장한다.
		 - 엑셀 시트 행을 반복하면서 데이터를 파싱해 db에 저장한다. 단 요약행은 skip 한다. (소계 등)
   
   - 위 공통 필드를 추출하여 DB에 저장.

   - 웹 크롤링 (URL 접근)
	   - 메가박스
		   - https://wingup.megabox.co.kr/login.do 으로 로그인 정보를 담아 post 요청.
		   - https://wingup.megabox.co.kr/wp/sha/searchMovie.do 을 post 요청해 상영 영화 리스트를 json으로 받아온다.
	   - 씨네큐
		   - https://score.cineq.co.kr/Login/LoginProcess url로 post 요청 로그인
		   - url get 요청을 반복하면서 데이터를 취합.
	   - 영화진흥위원회
		   - 로그인 정보(id, pw, 인증번호, utc milisec) 포함하여 던지기
	   - 각 사이트별로 위 공통 필드 데이터를 찾아 파싱 


5. 데이터 적재
- 파싱된 데이터를 위에서 설계한 DB 혹은 기존 테이블에 저장

6. 통계 생성
- 상영일자 기준으로 주간 통계 생성 쿼리 작성

7. 확인 및 다음 단계 (2024-05-27)
- 위 정의된 내용을 클라이언트께 컨펌
- 영화진흥위원회 로그인 정보 요청
	- https://www.kobis.or.kr/kobis/business/main/main.do
	- [x] id/pw/인증번호 확인 요청 ✅ 2024-05-27
- 주간 통계 노출을 원하시는 주소 및 메뉴 위치 요청
- [x] 구 사이트에서 숫자 변환 문제 발생되는 정확한 위치 확인 요청 ✅ 2024-05-27
- [x] 클라이언트 컨펌 후 실제 작업 진행 예정 ✅ 2024-05-27

8. 메일함 수집, 크롤링 파일 구조 설계
	1. 기존 mvc 패턴을 따른다.

| func | View            | Controller | Model (Service)                |
| ---- | --------------- | ---------- | ------------------------------ |
|      |                 |            | CollectEmailDAO.class.php      |
|      |                 |            | CrawlingMegaboxDAO.class.php   |
|      |                 |            | CrawlingCineqDAO.class.php     |
|      |                 |            | CrawlingKoficDAO.class.php     |
|      | log_history.php |            | ScoreUploadAcountDAO.class.php |
파일을 다운로드 받는 함수 / 데이터를 파싱하는 함수 분리
데이터를 받는다면, 파싱 후 데이터 적재는 어떻게?
- 각 로그인 접속 정보를 구db도 가지고 있어야 함. -> view 페이지 필요
- 로그인 정보 테이블 

| 사이트 | 배급사 | 아이디 | 패스워드 | 인증코드 |
| --- | --- | --- | ---- | ---- |
```sql
CREATE TABLE score_upload_account_management (
    site VARCHAR2(100),
    distributor VARCHAR2(100),
    account_id VARCHAR2(100),
    password VARCHAR2(100),
    authentication_code VARCHAR2(100),
    memo VARCHAR2(255);
);
```


### **설계가 안되면 코딩을 시작하지 않는다.
### 설계가 끝나야 코딩을 시작할 수 있다.** 

